ij> --
--    Mango - Open Source M2M - http://mango.serotoninsoftware.com
--    Copyright (C) 2006-2011 Serotonin Software Technologies Inc.
--    @author Matthew Lohbihler
--    
--    This program is free software: you can redistribute it and/or modify
--    it under the terms of the GNU General Public License as published by
--    the Free Software Foundation, either version 3 of the License, or
--    (at your option) any later version.
--
--    This program is distributed in the hope that it will be useful,
--    but WITHOUT ANY WARRANTY; without even the implied warranty of
--    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
--    GNU General Public License for more details.
--
--    You should have received a copy of the GNU General Public License
--    along with this program.  If not, see <http://www.gnu.org/licenses/>.
--
--

--
-- System settings
create table systemSettings (
  settingName varchar(32) not null,
  settingValue clob
);
0 rows inserted/updated/deleted
ij> alter table systemSettings add constraint systemSettingsPk primary key (settingName);
0 rows inserted/updated/deleted
ij> --
-- Users
create table users (
  id int not null generated by default as identity (start with 1, increment by 1),
  username varchar(40) not null,
  password varchar(30) not null,
  email varchar(255) not null,
  phone varchar(40),
  admin char(1) not null,
  disabled char(1) not null,
  lastLogin bigint,
  selectedWatchList int,
  homeUrl varchar(255),
  receiveAlarmEmails int not null,
  receiveOwnAuditEvents char(1) not null
);
0 rows inserted/updated/deleted
ij> alter table users add constraint usersPk primary key (id);
0 rows inserted/updated/deleted
ij> create table userComments (
  userId int,
  commentType int not null,
  typeKey int not null,
  ts bigint not null,
  commentText varchar(1024) not null
);
0 rows inserted/updated/deleted
ij> alter table userComments add constraint userCommentsFk1 foreign key (userId) references users(id);
0 rows inserted/updated/deleted
ij> --
-- Mailing lists
create table mailingLists (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  name varchar(40) not null
);
0 rows inserted/updated/deleted
ij> alter table mailingLists add constraint mailingListsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table mailingLists add constraint mailingListsUn1 unique (xid);
0 rows inserted/updated/deleted
ij> create table mailingListInactive (
  mailingListId int not null,
  inactiveInterval int not null
);
0 rows inserted/updated/deleted
ij> alter table mailingListInactive add constraint mailingListInactiveFk1 foreign key (mailingListId) 
  references mailingLists(id) on delete cascade;
0 rows inserted/updated/deleted
ij> create table mailingListMembers (
  mailingListId int not null,
  typeId int not null,
  userId int,
  address varchar(255)
);
0 rows inserted/updated/deleted
ij> alter table mailingListMembers add constraint mailingListMembersFk1 foreign key (mailingListId) 
  references mailingLists(id) on delete cascade;
0 rows inserted/updated/deleted
ij> --
--
-- Data Sources
--
create table dataSources (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  name varchar(40) not null,
  dataSourceType int not null,
  data blob not null
);
0 rows inserted/updated/deleted
ij> alter table dataSources add constraint dataSourcesPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table dataSources add constraint dataSourcesUn1 unique (xid);
0 rows inserted/updated/deleted
ij> -- Data source permissions
create table dataSourceUsers (
  dataSourceId int not null,
  userId int not null
);
0 rows inserted/updated/deleted
ij> alter table dataSourceUsers add constraint dataSourceUsersFk1 foreign key (dataSourceId) references dataSources(id);
0 rows inserted/updated/deleted
ij> alter table dataSourceUsers add constraint dataSourceUsersFk2 foreign key (userId) references users(id) on delete cascade;
0 rows inserted/updated/deleted
ij> --
--
-- scripts
--
create table scripts (
  id int not null generated by default as identity (start with 1, increment by 1),
  userId int not null,
  xid varchar(50) not null,
  name varchar(40) not null,
  script varchar(16384) not null,
  data blob not null
);
0 rows inserted/updated/deleted
ij> alter table scripts add constraint scriptsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table scripts add constraint scriptsFk1 foreign key (userId) references users(id);
0 rows inserted/updated/deleted
ij> --
--
-- Flex Projects
--
create table flexProjects(
  id int not null generated by default as identity (start with 1, increment by 1),
  name varchar(40) not null,
  description varchar(1024),
  xmlConfig varchar(16384) not null
);
0 rows inserted/updated/deleted
ij> --
--
-- Data Points
--
create table dataPoints (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  dataSourceId int not null,
  data blob not null
);
0 rows inserted/updated/deleted
ij> alter table dataPoints add constraint dataPointsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table dataPoints add constraint dataPointsUn1 unique (xid);
0 rows inserted/updated/deleted
ij> alter table dataPoints add constraint dataPointsFk1 foreign key (dataSourceId) references dataSources(id);
0 rows inserted/updated/deleted
ij> -- Data point permissions
create table dataPointUsers (
  dataPointId int not null,
  userId int not null,
  permission int not null
);
0 rows inserted/updated/deleted
ij> alter table dataPointUsers add constraint dataPointUsersFk1 foreign key (dataPointId) references dataPoints(id);
0 rows inserted/updated/deleted
ij> alter table dataPointUsers add constraint dataPointUsersFk2 foreign key (userId) references users(id) on delete cascade;
0 rows inserted/updated/deleted
ij> --
--
-- Views
--
create table mangoViews (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  name varchar(100) not null,
  background varchar(255),
  userId int not null,
  anonymousAccess int not null,
  data blob not null
);
0 rows inserted/updated/deleted
ij> alter table mangoViews add constraint mangoViewsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table mangoViews add constraint mangoViewsUn1 unique (xid);
0 rows inserted/updated/deleted
ij> alter table mangoViews add constraint mangoViewsFk1 foreign key (userId) references users(id) on delete cascade;
0 rows inserted/updated/deleted
ij> create table mangoViewUsers (
  mangoViewId int not null,
  userId int not null,
  accessType int not null
);
0 rows inserted/updated/deleted
ij> alter table mangoViewUsers add constraint mangoViewUsersPk primary key (mangoViewId, userId);
0 rows inserted/updated/deleted
ij> alter table mangoViewUsers add constraint mangoViewUsersFk1 foreign key (mangoViewId) references mangoViews(id) on delete cascade;
0 rows inserted/updated/deleted
ij> alter table mangoViewUsers add constraint mangoViewUsersFk2 foreign key (userId) references users(id) on delete cascade;
0 rows inserted/updated/deleted
ij> --
--
-- Point Values (historical data)
--
create table pointValues (
  id bigint not null generated by default as identity (start with 1, increment by 1),
  dataPointId int not null,
  dataType int not null,
  pointValue double,
  ts bigint not null
);
0 rows inserted/updated/deleted
ij> alter table pointValues add constraint pointValuesPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table pointValues add constraint pointValuesFk1 foreign key (dataPointId) references dataPoints(id) on delete cascade;
0 rows inserted/updated/deleted
ij> create index pointValuesIdx1 on pointValues (ts, dataPointId);
0 rows inserted/updated/deleted
ij> create index pointValuesIdx2 on pointValues (dataPointId, ts);
0 rows inserted/updated/deleted
ij> create table pointValueAnnotations (
  pointValueId bigint not null,
  textPointValueShort varchar(128),
  textPointValueLong clob,
  sourceType smallint,
  sourceId int
);
0 rows inserted/updated/deleted
ij> alter table pointValueAnnotations add constraint pointValueAnnotationsFk1 foreign key (pointValueId) 
  references pointValues(id) on delete cascade;
0 rows inserted/updated/deleted
ij> --
--
-- Watch list
--
create table watchLists (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  userId int not null,
  name varchar(50)
);
0 rows inserted/updated/deleted
ij> alter table watchLists add constraint watchListsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table watchLists add constraint watchListsUn1 unique (xid);
0 rows inserted/updated/deleted
ij> alter table watchLists add constraint watchListsFk1 foreign key (userId) references users(id) on delete cascade;
0 rows inserted/updated/deleted
ij> create table watchListPoints (
  watchListId int not null,
  dataPointId int not null,
  sortOrder int not null
);
0 rows inserted/updated/deleted
ij> alter table watchListPoints add constraint watchListPointsFk1 foreign key (watchListId) references watchLists(id) on delete cascade;
0 rows inserted/updated/deleted
ij> alter table watchListPoints add constraint watchListPointsFk2 foreign key (dataPointId) references dataPoints(id);
0 rows inserted/updated/deleted
ij> create table watchListUsers (
  watchListId int not null,
  userId int not null,
  accessType int not null
);
0 rows inserted/updated/deleted
ij> alter table watchListUsers add constraint watchListUsersPk primary key (watchListId, userId);
0 rows inserted/updated/deleted
ij> alter table watchListUsers add constraint watchListUsersFk1 foreign key (watchListId) references watchLists(id) on delete cascade;
0 rows inserted/updated/deleted
ij> alter table watchListUsers add constraint watchListUsersFk2 foreign key (userId) references users(id) on delete cascade;
0 rows inserted/updated/deleted
ij> --
--
-- Point event detectors
--
create table pointEventDetectors (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  alias varchar(255),
  dataPointId int not null,
  detectorType int not null,
  alarmLevel int not null,
  stateLimit double,
  duration int,
  durationType int,
  binaryState char(1),
  multistateState int,
  changeCount int,
  alphanumericState varchar(128),
  weight double
);
0 rows inserted/updated/deleted
ij> alter table pointEventDetectors add constraint pointEventDetectorsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table pointEventDetectors add constraint pointEventDetectorsUn1 unique (xid, dataPointId);
0 rows inserted/updated/deleted
ij> alter table pointEventDetectors add constraint pointEventDetectorsFk1 foreign key (dataPointId) 
  references dataPoints(id);
0 rows inserted/updated/deleted
ij> --
--
-- Events
--
create table events (
  id int not null generated by default as identity (start with 1, increment by 1),
  typeId int not null,
  typeRef1 int not null,
  typeRef2 int not null,
  activeTs bigint not null,
  rtnApplicable char(1) not null,
  rtnTs bigint,
  rtnCause int,
  alarmLevel int not null,
  message clob,
  ackTs bigint,
  ackUserId int,
  alternateAckSource int
);
0 rows inserted/updated/deleted
ij> alter table events add constraint eventsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table events add constraint eventsFk1 foreign key (ackUserId) references users(id);
0 rows inserted/updated/deleted
ij> create table userEvents (
  eventId int not null,
  userId int not null,
  silenced char(1) not null
);
0 rows inserted/updated/deleted
ij> alter table userEvents add constraint userEventsPk primary key (eventId, userId);
0 rows inserted/updated/deleted
ij> alter table userEvents add constraint userEventsFk1 foreign key (eventId) references events(id) on delete cascade;
0 rows inserted/updated/deleted
ij> alter table userEvents add constraint userEventsFk2 foreign key (userId) references users(id) on delete cascade;
0 rows inserted/updated/deleted
ij> --
--
-- Event handlers
--
create table eventHandlers (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  alias varchar(255),
  
  -- Event type, see events
  eventTypeId int not null,
  eventTypeRef1 int not null,
  eventTypeRef2 int not null,
  
  data blob not null
);
0 rows inserted/updated/deleted
ij> alter table eventHandlers add constraint eventHandlersPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table eventHandlers add constraint eventHandlersUn1 unique (xid);
0 rows inserted/updated/deleted
ij> --
--
-- Scheduled events
--
create table scheduledEvents (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  alias varchar(255),
  alarmLevel int not null,
  scheduleType int not null,
  returnToNormal char(1) not null,
  disabled char(1) not null,
  activeYear int,
  activeMonth int,
  activeDay int,
  activeHour int,
  activeMinute int,
  activeSecond int,
  activeCron varchar(25),
  inactiveYear int,
  inactiveMonth int,
  inactiveDay int,
  inactiveHour int,
  inactiveMinute int,
  inactiveSecond int,
  inactiveCron varchar(25)
);
0 rows inserted/updated/deleted
ij> alter table scheduledEvents add constraint scheduledEventsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table scheduledEvents add constraint scheduledEventsUn1 unique (xid);
0 rows inserted/updated/deleted
ij> --
--
-- Point Hierarchy
--
create table pointHierarchy (
  id int not null generated by default as identity (start with 1, increment by 1),
  parentId int,
  name varchar(100)
);
0 rows inserted/updated/deleted
ij> alter table pointHierarchy add constraint pointHierarchyPk primary key (id);
0 rows inserted/updated/deleted
ij> --
--
-- Compound events detectors
--
create table compoundEventDetectors (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  name varchar(100),
  alarmLevel int not null,
  returnToNormal char(1) not null,
  disabled char(1) not null,
  conditionText varchar(256) not null
);
0 rows inserted/updated/deleted
ij> alter table compoundEventDetectors add constraint compoundEventDetectorsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table compoundEventDetectors add constraint compoundEventDetectorsUn1 unique (xid);
0 rows inserted/updated/deleted
ij> --
--
-- Reports
--
create table reports (
  id int not null generated by default as identity (start with 1, increment by 1),
  userId int not null,
  name varchar(100) not null,
  data blob not null
);
0 rows inserted/updated/deleted
ij> alter table reports add constraint reportsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table reports add constraint reportsFk1 foreign key (userId) references users(id) on delete cascade;
0 rows inserted/updated/deleted
ij> create table reportInstances (
  id int not null generated by default as identity (start with 1, increment by 1),
  userId int not null,
  name varchar(100) not null,
  includeEvents int not null,
  includeUserComments char(1) not null,
  reportStartTime bigint not null,
  reportEndTime bigint not null,
  runStartTime bigint,
  runEndTime bigint,
  recordCount int,
  preventPurge char(1)
);
0 rows inserted/updated/deleted
ij> alter table reportInstances add constraint reportInstancesPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table reportInstances add constraint reportInstancesFk1 foreign key (userId) references users(id) on delete cascade;
0 rows inserted/updated/deleted
ij> create table reportInstancePoints (
  id int not null generated by default as identity (start with 1, increment by 1),
  reportInstanceId int not null,
  dataSourceName varchar(40) not null,
  pointName varchar(100) not null,
  dataType int not null,
  startValue varchar(4096),
  textRenderer blob,
  colour varchar(6),
  consolidatedChart char(1)
);
0 rows inserted/updated/deleted
ij> alter table reportInstancePoints add constraint reportInstancePointsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table reportInstancePoints add constraint reportInstancePointsFk1 foreign key (reportInstanceId) 
  references reportInstances(id) on delete cascade;
0 rows inserted/updated/deleted
ij> create table reportInstanceData (
  pointValueId bigint not null,
  reportInstancePointId int not null,
  pointValue double,
  ts bigint not null
);
0 rows inserted/updated/deleted
ij> alter table reportInstanceData add constraint reportInstanceDataPk primary key (pointValueId, reportInstancePointId);
0 rows inserted/updated/deleted
ij> alter table reportInstanceData add constraint reportInstanceDataFk1 foreign key (reportInstancePointId) 
  references reportInstancePoints(id) on delete cascade;
0 rows inserted/updated/deleted
ij> create table reportInstanceDataAnnotations (
  pointValueId bigint not null,
  reportInstancePointId int not null,
  textPointValueShort varchar(128),
  textPointValueLong clob,
  sourceValue varchar(128)
);
0 rows inserted/updated/deleted
ij> alter table reportInstanceDataAnnotations add constraint reportInstanceDataAnnotationsPk 
  primary key (pointValueId, reportInstancePointId);
0 rows inserted/updated/deleted
ij> alter table reportInstanceDataAnnotations add constraint reportInstanceDataAnnotationsFk1 
  foreign key (pointValueId, reportInstancePointId) references reportInstanceData(pointValueId, reportInstancePointId) 
  on delete cascade;
0 rows inserted/updated/deleted
ij> create table reportInstanceEvents (
  eventId int not null,
  reportInstanceId int not null,
  typeId int not null,
  typeRef1 int not null,
  typeRef2 int not null,
  activeTs bigint not null,
  rtnApplicable char(1) not null,
  rtnTs bigint,
  rtnCause int,
  alarmLevel int not null,
  message clob,
  ackTs bigint,
  ackUsername varchar(40),
  alternateAckSource int
);
0 rows inserted/updated/deleted
ij> alter table reportInstanceEvents add constraint reportInstanceEventsPk primary key (eventId, reportInstanceId);
0 rows inserted/updated/deleted
ij> alter table reportInstanceEvents add constraint reportInstanceEventsFk1 foreign key (reportInstanceId)
  references reportInstances(id) on delete cascade;
0 rows inserted/updated/deleted
ij> create table reportInstanceUserComments (
  reportInstanceId int not null,
  username varchar(40),
  commentType int not null,
  typeKey int not null,
  ts bigint not null,
  commentText varchar(1024) not null
);
0 rows inserted/updated/deleted
ij> alter table reportInstanceUserComments add constraint reportInstanceUserCommentsFk1 foreign key (reportInstanceId)
  references reportInstances(id) on delete cascade;
0 rows inserted/updated/deleted
ij> --
--
-- Publishers
--
create table publishers (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  data blob not null
);
0 rows inserted/updated/deleted
ij> alter table publishers add constraint publishersPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table publishers add constraint publishersUn1 unique (xid);
0 rows inserted/updated/deleted
ij> --
--
-- Point links
--
create table pointLinks (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  sourcePointId int not null,
  targetPointId int not null,
  script clob,
  eventType int not null,
  disabled char(1) not null
);
0 rows inserted/updated/deleted
ij> alter table pointLinks add constraint pointLinksPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table pointLinks add constraint pointLinksUn1 unique (xid);
0 rows inserted/updated/deleted
ij> --
--
-- Maintenance events
--
create table maintenanceEvents (
  id int not null generated by default as identity (start with 1, increment by 1),
  xid varchar(50) not null,
  dataSourceId int not null,
  alias varchar(255),
  alarmLevel int not null,
  scheduleType int not null,
  disabled char(1) not null,
  activeYear int,
  activeMonth int,
  activeDay int,
  activeHour int,
  activeMinute int,
  activeSecond int,
  activeCron varchar(25),
  inactiveYear int,
  inactiveMonth int,
  inactiveDay int,
  inactiveHour int,
  inactiveMinute int,
  inactiveSecond int,
  inactiveCron varchar(25)
);
0 rows inserted/updated/deleted
ij> alter table maintenanceEvents add constraint maintenanceEventsPk primary key (id);
0 rows inserted/updated/deleted
ij> alter table maintenanceEvents add constraint maintenanceEventsUn1 unique (xid);
0 rows inserted/updated/deleted
ij> alter table maintenanceEvents add constraint maintenanceEventsFk1 foreign key (dataSourceId) references dataSources(id);
0 rows inserted/updated/deleted
ij> 